FROM ubuntu:18.04

ARG DEBIAN_FRONTEND=noninteractive
ARG APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1

# install OS tools
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends -o=Dpkg::Use-Pty=0 \
        apt-utils \
        wget \
        make \
        build-essential \
        pkg-config \
        cmake \
        ca-certificates \
        gnupg \
        cpio && \
    rm -rf /var/lib/apt/lists/*

RUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 6B05F25D762E3157 && \
    apt-get update

COPY parallel_studio_xe_2018_update4_cluster_edition.tgz /var/tmp/parallel_studio_xe_2018_update4_cluster_edition.tgz
COPY NCOM_L___S477-ZZCBSCXC.lic /var/tmp/license.lic

RUN --mount=type=secret,id=gerrit_user,dst=/tmp/gerrit_user.txt tar -x -f /var/tmp/parallel_studio_xe_2018_update4_cluster_edition.tgz -C /var/tmp -z && \
    sed -i -e 's/^#\?\(COMPONENTS\)=.*/\1=intel-icc__x86_64;intel-ifort__x86_64;intel-mkl-core__x86_64;intel-ifort-common__noarch;intel-icc-common__noarch;intel-icc-common-ps__noarch;intel-mkl-cluster__x86_64;intel-mkl-gnu__x86_64;intel-mkl-doc__noarch;intel-mkl-doc-ps__noarch;intel-mkl-common-ps__noarch;intel-mkl-core-ps__x86_64;intel-mkl-gnu-rt__x86_64;intel-mkl-common__noarch;intel-mkl-core-f__x86_64;intel-mkl-gnu-f__x86_64;intel-mkl-f95-common__noarch;intel-mkl-f__x86_64;intel-mkl-common-f__noarch;intel-mkl-cluster-c__noarch;intel-mkl-common-c-ps__noarch;intel-mkl-core-c__x86_64;intel-mkl-gnu-c__x86_64;intel-mkl-common-c__noarch;intel-mpi-rt__x86_64;intel-mpi-sdk__x86_64;intel-mpi-installer-license__x86_64;intel-mpi-psxe__x86_64;intel-mpi-rt-psxe__x86_64;intel-mkl-psxe__noarch;intel-ippcp-psxe__noarch;intel-psxe-common__noarch;intel-ippcp-psxe__noarch;intel-psxe-licensing__noarch;intel-icsxe-pset;intel-icsxe__noarch;intel-imb__x86_64;intel-ips__noarch;intel-ipsc__noarch;intel-ipsf__noarch;intel-openmp__x86_64;intel-openmp-common__noarch;intel-openmp-common-icc__noarch;intel-openmp-common-ifort__noarch;intel-openmp-ifort__x86_64;intel-comp__x86_64;intel-comp-l-all-common__noarch;intel-comp-l-all-vars__noarch;intel-comp-nomcu-vars__noarch;intel-comp-ps__x86_64;intel-comp-ps-ss-bec__x86_64;intel-gdb__x86_64;intel-gdb-source__noarch;intel-gdb-common__noarch;/g' \
        -e 's|^#\?\(PSET_INSTALL_DIR\)=.*|\1=/opt/intel|g' \
        -e 's/^#\?\(ACCEPT_EULA\)=.*/\1=accept/g' \
        -e 's/^#\?\(ACTIVATION_TYPE\)=.*/\1=license_file/g' \
        -e 's|^#\?\(ACTIVATION_LICENSE_FILE\)=.*|\1=/var/tmp/license.lic|g' /var/tmp/parallel_studio_xe_2018_update4_cluster_edition/silent.cfg && \
    cd /var/tmp/parallel_studio_xe_2018_update4_cluster_edition && ./install.sh --silent=silent.cfg && \
    rm -rf /var/tmp/parallel_studio_xe_2018_update4_cluster_edition.tgz /var/tmp/parallel_studio_xe_2018_update4_cluster_edition

RUN rm -rf /opt/intel/ide_support_2018 && \
    rm -rf /opt/intel/compilers_and_libraries_2018/linux/lib/ia32* && \
    rm -rf /opt/intel/compilers_and_libriaries_2018.4.057/linux/tbb/lib/ia32* && \
    ln -s /usr/bin/make /usr/bin/gmake

RUN echo "if [ -z \"$INTEL_SH_GUARD\" ]; then" > /etc/profile.d/intel.sh \
    && echo "    source /opt/intel/compilers_and_libraries/linux/bin/compilervars.sh intel64" >> /etc/profile.d/intel.sh \
    && echo "    source /opt/intel/compilers_and_libraries/linux/mpi/bin64/mpivars.sh" >> /etc/profile.d/intel.sh \
    && echo "fi" >> /etc/profile.d/intel.sh \
    && echo "export INTEL_SH_GUARD=1" >> /etc/profile.d/intel.sh \
    && chmod a+x /etc/profile.d/intel.sh
